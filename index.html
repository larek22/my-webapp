<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Telegram Web App - Озвучивание</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f0f2f5;
      margin: 0;
      padding: 20px;
    }
    .container {
      max-width: 600px;
      margin: auto;
      background: #fff;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    h1 {
      text-align: center;
      color: #333;
    }
    label {
      font-weight: bold;
    }
    select, input[type="range"], textarea {
      width: 100%;
      padding: 10px;
      margin-top: 5px;
      border-radius: 5px;
      border: 1px solid #ccc;
      box-sizing: border-box;
    }
    .slider-value {
      text-align: right;
      font-size: 14px;
      color: #555;
    }
    button {
      background-color: #0088cc;
      border: none;
      color: white;
      padding: 10px;
      font-size: 16px;
      border-radius: 5px;
      cursor: pointer;
      margin-top: 15px;
      width: 100%;
    }
    button:hover {
      background-color: #007ab8;
    }
    .hidden {
      display: none;
    }
    .button-row {
      display: flex;
      justify-content: space-between;
      gap: 10px;
    }
    .button-row button {
      width: 48%;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Озвучивание текста</h1>
    <p>Выберите голос, настройте параметры и введите текст для озвучивания через ElevenLabs.</p>
    
    <label for="voiceSelect">Выберите голос:</label>
    <select id="voiceSelect">
      <option value="21m00Tcm4TlvDq8ikWAM">Standard Male (Default)</option>
      <option value="EXAVITQu4vr4xnSDxMaL">Standard Female</option>
      <option value="AZnzlk1XvdvUeBnOPNw0">Standard Neutral</option>
    </select>
    
    <br><br>
    
    <label for="stabilityRange">Стабильность: <span id="stabilityValue">0.75</span></label>
    <input type="range" id="stabilityRange" min="0" max="1" step="0.01" value="0.75">
    
    <br><br>
    
    <label for="similarityRange">Похожесть: <span id="similarityValue">0.75</span></label>
    <input type="range" id="similarityRange" min="0" max="1" step="0.01" value="0.75">
    
    <br><br>
    
    <label for="textInput">Введите текст:</label>
    <textarea id="textInput" rows="4" placeholder="Введите текст для озвучивания..."></textarea>
    
    <button id="previewButton">Предпрослушивание</button>
    
    <!-- Контейнер для аудиоплеера и дополнительных кнопок -->
    <div id="playerContainer" class="hidden">
      <h3>Предпрослушивание</h3>
      <audio id="audioPlayer" controls></audio>
      <div class="button-row">
        <button id="downloadButton">Скачать</button>
        <button id="sendButton">Отправить голосовым</button>
      </div>
    </div>
    
    <p style="font-size: 14px; color: #777;">
      После предпрослушивания выберите дальнейшее действие.
    </p>
  </div>
  
  <script>
    // Инициализация Telegram Web App
    const webApp = window.Telegram.WebApp;
    webApp.expand();

    // Элементы интерфейса
    const stabilityRange = document.getElementById("stabilityRange");
    const stabilityValue = document.getElementById("stabilityValue");
    const similarityRange = document.getElementById("similarityRange");
    const similarityValue = document.getElementById("similarityValue");
    const previewButton = document.getElementById("previewButton");
    const playerContainer = document.getElementById("playerContainer");
    const audioPlayer = document.getElementById("audioPlayer");
    const downloadButton = document.getElementById("downloadButton");
    const sendButton = document.getElementById("sendButton");

    // Обновление значений слайдеров
    stabilityRange.addEventListener("input", () => {
      stabilityValue.textContent = stabilityRange.value;
    });
    similarityRange.addEventListener("input", () => {
      similarityValue.textContent = similarityRange.value;
    });

    // URL вашего серверлес‑endpoint для генерации аудио (должен быть https!)
    const AUDIO_GENERATION_ENDPOINT = "https://yourserver.com/api/generate-audio";

    // Функция предпрослушивания: вызываем сервер для генерации аудио
    async function previewAudio() {
      const voice = document.getElementById("voiceSelect").value;
      const stability = stabilityRange.value;
      const similarity = similarityRange.value;
      const text = document.getElementById("textInput").value.trim();

      if (!text) {
        alert("Пожалуйста, введите текст.");
        return;
      }

      previewButton.disabled = true;
      previewButton.textContent = "Генерация аудио...";

      try {
        const response = await fetch(AUDIO_GENERATION_ENDPOINT, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            voice: voice,
            stability: stability,
            similarity_boost: similarity,
            text: text
          })
        });
        if (!response.ok) throw new Error("Ошибка генерации аудио");
        const data = await response.json();
        // Ожидаем, что endpoint вернул объект { audio: "data:audio/mpeg;base64,..." }
        const audioDataUrl = data.audio;
        // Устанавливаем аудиоплеер
        audioPlayer.src = audioDataUrl;
        playerContainer.classList.remove("hidden");
      } catch (error) {
        alert("Ошибка при генерации аудио: " + error);
      } finally {
        previewButton.disabled = false;
        previewButton.textContent = "Предпрослушивание";
      }
    }

    previewButton.addEventListener("click", previewAudio);

    // Функция скачивания аудио
    function downloadAudio() {
      const link = document.createElement("a");
      link.href = audioPlayer.src;
      link.download = "preview.mp3";
      link.click();
    }

    downloadButton.addEventListener("click", downloadAudio);

    // Функция отправки голосового: отправляем исходные параметры в бота
    function sendVoice() {
      const voice = document.getElementById("voiceSelect").value;
      const stability = stabilityRange.value;
      const similarity = similarityRange.value;
      const text = document.getElementById("textInput").value.trim();

      if (!text) {
        alert("Пожалуйста, введите текст.");
        return;
      }

      // Отправляем данные в бота – бот повторно сгенерирует аудио и отправит его в чат
      const payload = {
        voice: voice,
        stability: stability,
        similarity_boost: similarity,
        text: text,
        action: "send"
      };
      webApp.sendData(JSON.stringify(payload));
      alert("Данные отправлены в Telegram. Проверьте чат для голосового сообщения.");
    }

    sendButton.addEventListener("click", sendVoice);
  </script>
</body>
</html>
